<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Active Directory/Guides/Active_Directory_domain_join_with_AWS_Systems_Manager_and_AWS_Secrets_Manager/index" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Active Directory domain join with AWS Systems Manager and AWS Secrets Manager | Technical Notes for Microsoft Workloads on AWS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://aws-samples.github.io/technical-notes-for-microsoft-workloads-on-aws/Active Directory/Guides/Active_Directory_domain_join_with_AWS_Systems_Manager_and_AWS_Secrets_Manager/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Active Directory domain join with AWS Systems Manager and AWS Secrets Manager | Technical Notes for Microsoft Workloads on AWS"><meta data-rh="true" name="description" content="by Syed Ahmad"><meta data-rh="true" property="og:description" content="by Syed Ahmad"><link data-rh="true" rel="icon" href="/technical-notes-for-microsoft-workloads-on-aws/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aws-samples.github.io/technical-notes-for-microsoft-workloads-on-aws/Active Directory/Guides/Active_Directory_domain_join_with_AWS_Systems_Manager_and_AWS_Secrets_Manager/"><link data-rh="true" rel="alternate" href="https://aws-samples.github.io/technical-notes-for-microsoft-workloads-on-aws/Active Directory/Guides/Active_Directory_domain_join_with_AWS_Systems_Manager_and_AWS_Secrets_Manager/" hreflang="en"><link data-rh="true" rel="alternate" href="https://aws-samples.github.io/technical-notes-for-microsoft-workloads-on-aws/Active Directory/Guides/Active_Directory_domain_join_with_AWS_Systems_Manager_and_AWS_Secrets_Manager/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Active Directory","item":"https://aws-samples.github.io/technical-notes-for-microsoft-workloads-on-aws/Active Directory/"},{"@type":"ListItem","position":2,"name":"Guides","item":"https://aws-samples.github.io/technical-notes-for-microsoft-workloads-on-aws/Active Directory/Guides/"},{"@type":"ListItem","position":3,"name":"Active Directory domain join with AWS Systems Manager and AWS Secrets Manager","item":"https://aws-samples.github.io/technical-notes-for-microsoft-workloads-on-aws/Active Directory/Guides/Active_Directory_domain_join_with_AWS_Systems_Manager_and_AWS_Secrets_Manager/"}]}</script><link rel="alternate" type="application/rss+xml" href="/technical-notes-for-microsoft-workloads-on-aws/blog/rss.xml" title="Technical Notes for Microsoft Workloads on AWS RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/technical-notes-for-microsoft-workloads-on-aws/blog/atom.xml" title="Technical Notes for Microsoft Workloads on AWS Atom Feed"><link rel="stylesheet" href="/technical-notes-for-microsoft-workloads-on-aws/assets/css/styles.7d891adc.css">
<script src="/technical-notes-for-microsoft-workloads-on-aws/assets/js/runtime~main.d4006d61.js" defer="defer"></script>
<script src="/technical-notes-for-microsoft-workloads-on-aws/assets/js/main.c70e6baf.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/technical-notes-for-microsoft-workloads-on-aws/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/technical-notes-for-microsoft-workloads-on-aws/"><div class="navbar__logo"><img src="/technical-notes-for-microsoft-workloads-on-aws/img/logo.svg" alt="AWS Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/technical-notes-for-microsoft-workloads-on-aws/img/logo.svg" alt="AWS Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Technical Notes for Microsoft Workloads on AWS</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/technical-notes-for-microsoft-workloads-on-aws/home">Home</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/technical-notes-for-microsoft-workloads-on-aws/DotNET/Guides/">.NET</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/technical-notes-for-microsoft-workloads-on-aws/Active Directory/Guides/">Active Directory</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/technical-notes-for-microsoft-workloads-on-aws/Windows Containers/Guides/">Windows Containers</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/technical-notes-for-microsoft-workloads-on-aws/SQL Server/Guides/">SQL Server</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/technical-notes-for-microsoft-workloads-on-aws/EC2 Windows/Guides/">EC2 Windows</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/technical-notes-for-microsoft-workloads-on-aws/Licensing/Guides/">Licensing</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/technical-notes-for-microsoft-workloads-on-aws/Desktop Engineering/Guides/">Desktop Engineering</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/aws-samples/technical-notes-for-microsoft-workloads-on-aws" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/technical-notes-for-microsoft-workloads-on-aws/home"><span title="About Technical Notes for Microsoft Workloads on AWS" class="linkLabel_WmDU">About Technical Notes for Microsoft Workloads on AWS</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/technical-notes-for-microsoft-workloads-on-aws/Desktop Engineering/"><span title="Desktop Engineering" class="categoryLinkLabel_W154">Desktop Engineering</span></a><button aria-label="Expand sidebar category &#x27;Desktop Engineering&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/technical-notes-for-microsoft-workloads-on-aws/DotNET/"><span title=".NET" class="categoryLinkLabel_W154">.NET</span></a><button aria-label="Expand sidebar category &#x27;.NET&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/technical-notes-for-microsoft-workloads-on-aws/Active Directory/"><span title="Active Directory" class="categoryLinkLabel_W154">Active Directory</span></a><button aria-label="Collapse sidebar category &#x27;Active Directory&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" tabindex="0" href="/technical-notes-for-microsoft-workloads-on-aws/Active Directory/Guides/"><span title="Guides" class="categoryLinkLabel_W154">Guides</span></a><button aria-label="Collapse sidebar category &#x27;Guides&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/technical-notes-for-microsoft-workloads-on-aws/Active Directory/Guides/Windows_LAPS_&amp;_AWS_Microsoft_Managed_Active_Directory/"><span title="Quickly deploy a self-managed AD Forest on Amazon EC2" class="linkLabel_WmDU">Quickly deploy a self-managed AD Forest on Amazon EC2</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/technical-notes-for-microsoft-workloads-on-aws/Active Directory/Guides/Optimizing_Directory_Sharing_in_AWS_Managed_Microsoft_AD/"><span title="Optimizing Directory Sharing in AWS Managed Microsoft AD" class="linkLabel_WmDU">Optimizing Directory Sharing in AWS Managed Microsoft AD</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/technical-notes-for-microsoft-workloads-on-aws/Active Directory/Guides/Active_Directory_domain_join_with_AWS_Systems_Manager_and_AWS_Secrets_Manager/"><span title="Active Directory domain join with AWS Systems Manager and AWS Secrets Manager" class="linkLabel_WmDU">Active Directory domain join with AWS Systems Manager and AWS Secrets Manager</span></a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/technical-notes-for-microsoft-workloads-on-aws/Windows Containers/"><span title="Windows Containers" class="categoryLinkLabel_W154">Windows Containers</span></a><button aria-label="Expand sidebar category &#x27;Windows Containers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/technical-notes-for-microsoft-workloads-on-aws/SQL Server/"><span title="SQL Server" class="categoryLinkLabel_W154">SQL Server</span></a><button aria-label="Expand sidebar category &#x27;SQL Server&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/technical-notes-for-microsoft-workloads-on-aws/EC2 Windows/"><span title="EC2 Windows" class="categoryLinkLabel_W154">EC2 Windows</span></a><button aria-label="Expand sidebar category &#x27;EC2 Windows&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/technical-notes-for-microsoft-workloads-on-aws/Licensing/"><span title="Licensing" class="categoryLinkLabel_W154">Licensing</span></a><button aria-label="Expand sidebar category &#x27;Licensing&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/technical-notes-for-microsoft-workloads-on-aws/AWS re:Invent/"><span title="AWS re:Invent" class="categoryLinkLabel_W154">AWS re:Invent</span></a><button aria-label="Expand sidebar category &#x27;AWS re:Invent&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/technical-notes-for-microsoft-workloads-on-aws/Code Repo/"><span title="Code Repo" class="categoryLinkLabel_W154">Code Repo</span></a><button aria-label="Expand sidebar category &#x27;Code Repo&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/technical-notes-for-microsoft-workloads-on-aws/Workshops"><span title="Workshops" class="linkLabel_WmDU">Workshops</span></a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/technical-notes-for-microsoft-workloads-on-aws/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/technical-notes-for-microsoft-workloads-on-aws/Active Directory/"><span>Active Directory</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/technical-notes-for-microsoft-workloads-on-aws/Active Directory/Guides/"><span>Guides</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Active Directory domain join with AWS Systems Manager and AWS Secrets Manager</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Active Directory domain join with AWS Systems Manager and AWS Secrets Manager</h1></header>
<p>by Syed Ahmad</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" translate="no">​</a></h2>
<p>Using <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-automation.html" target="_blank" rel="noopener noreferrer" class="">AWS Systems Manager Automation</a>, you can dynamically automate domain join and unjoin activities with Microsoft Active Directory (AD) for your <a href="https://docs.aws.amazon.com/ec2" target="_blank" rel="noopener noreferrer" class="">Amazon Elastic Compute Cloud</a> (Amazon EC2) Windows instances. With Automation, you can use <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/automation-documents.html" target="_blank" rel="noopener noreferrer" class="">runbooks</a> to perform domain join and unjoin activities manually, automatically, or event-driven. You no longer have to rely on legacy login scripts or third-party software to perform such operations, which cannot be easily scaled in the cloud.</p>
<p>With built-in multiple AWS account and AWS Region support, Systems Manager Automation can ease the domain join and unjoin tasks for your Windows workloads at any size. Automation is flexible as it supports hybrid AD environments, self-managed AD running on Windows Amazon EC2 instances, and <a href="https://aws.amazon.com/directoryservice/features/?nc=sn&amp;loc=2" target="_blank" rel="noopener noreferrer" class="">AWS Directory Service for Microsoft Active Directory (AWS Managed Microsoft AD)</a>. Finally, Systems Manager Automation runbooks can be the glue to other event-driven AWS services. For example, Automation can be used together with Amazon EC2 Auto Scaling to support domain join or unjoin activities for your dynamic fleet of Windows EC2 instances.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="solution-overview">Solution overview<a href="#solution-overview" class="hash-link" aria-label="Direct link to Solution overview" title="Direct link to Solution overview" translate="no">​</a></h2>
<p>This post will demonstrate how to manually run Automation against a Windows Amazon EC2 instance to join an <a href="https://docs.aws.amazon.com/directoryservice/latest/admin-guide/directory_microsoft_ad.html" target="_blank" rel="noopener noreferrer" class="">AWS Managed Microsoft AD</a> domain. The steps outlined in this post are also applicable for AD environments in a hybrid cloud or a self-managed AD running on Amazon EC2 instances.</p>
<p>To deploy the runbook and parameters automatically, [download] and save the <a href="https://github.com/aws-samples/ssm-automation-custom-ad-domain-join-unjoin/blob/main/templates/cloudformation/cfn-create-ssm-automation-secretmanager-adjoin.yml" target="_blank" rel="noopener noreferrer" class="">AWS CloudFormation template</a> from GitHub locally to your computer to create a new CloudFormation stack. Creating a new stack will simplify the deployment of the Automation runbook and create the appropriate parameters to perform the AD join and unjoin activities automatically.</p>
<p>A CloudFormation stack (Figure 1) is created with the name <strong>SSM-Automation-Demo</strong>. The first input parameter in the stack requires you to enter a name for the Automation runbook. For this demo, I will use <strong>SSM-Automation-AD-Join</strong>, though you can enter any name you like as long as it meets the requirements referenced on the stack creation screen. The remaining four input parameters in the stack create the Secrets Manager secret store the AD credentials for the AD domain join and unjoin activities.</p>
<p><img decoding="async" loading="lazy" src="/technical-notes-for-microsoft-workloads-on-aws/assets/images/image1-39effeef6665a601119502290cc9bdc1.png" width="1428" height="913" class="img_ev3q"></p>
<p>Figure 1: Example screenshot of AWS CloudFormation stack creation.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-automation-runbook-workflow">The Automation runbook workflow<a href="#the-automation-runbook-workflow" class="hash-link" aria-label="Direct link to The Automation runbook workflow" title="Direct link to The Automation runbook workflow" translate="no">​</a></h2>
<p>This custom runbook is the central piece of the AD domain join and unjoin workflow. Using this runbook, administrators can manually or automatically trigger domain join or unjoin for their Windows Amazon EC2 instance to or from an AD domain. This post will demonstrate the manual execution of the Automation. The following parameters that need to be specified.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="parameters">Parameters<a href="#parameters" class="hash-link" aria-label="Direct link to Parameters" title="Direct link to Parameters" translate="no">​</a></h3>
<ul>
<li class=""><em><strong>AutomationAssumeRole</strong></em> -- This optional service role gives the automation permission to perform actions on your behalf, for example, when configuring automatic domain join and unjoin activities with <a href="https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-what-is.html" target="_blank" rel="noopener noreferrer" class="">Amazon EventBridge</a> or <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-state.html" target="_blank" rel="noopener noreferrer" class="">AWS Systems Manager State Manager</a>.</li>
<li class=""><em><strong>InstanceId</strong></em> -- The Windows Amazon EC2 instance ID where your runbook will run the commands. The instance ID is persistent throughout the runbook.</li>
<li class=""><em><strong>DomainJoinActivity</strong></em> -- A dropdown option allowing you to select to either <strong>Join</strong> or <strong>Unjoin</strong> from an AD domain. Depending on which option you choose, the runbook will perform the appropriate follow-up steps.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="runbook-steps">Runbook steps<a href="#runbook-steps" class="hash-link" aria-label="Direct link to Runbook steps" title="Direct link to Runbook steps" translate="no">​</a></h2>
<p>There are 9 steps in the Automation workflow. Here are descriptions of the key steps and how they factor into the AD domain join and unjoin activities.</p>
<ul>
<li class=""><em><strong>assertInstanceIsWindows</strong></em> -- The first step checks if the Amazon EC2 instance is running Windows and will only continue if the platform is Windows. The aws<!-- -->:assertAwsResourceProperty<!-- --> action allows you to assert a specific resource state or event state for a specific Automation step. Visit aws<!-- -->:assertAwsResourceProperty<!-- -->, to learn more.</li>
<li class=""><em><strong>chooseDomainJoinActivity</strong></em> -- This step is associated with the aws<!-- -->:branch<!-- --> action, which allows Automation to conditionally follow the steps relevant to join an AD domain or unjoin from an AD domain. It is similar in concept to a basic if-else statement in PowerShell, for example. Visit aws<!-- -->:branch<!-- --> to learn more.</li>
</ul>
<p>Below are the decision trees that explain the steps in sequence for both successful and failed domain joins (Figure 2) and unjoins (Figure 3).</p>
<p><img decoding="async" loading="lazy" src="/technical-notes-for-microsoft-workloads-on-aws/assets/images/image2-44ba34247bbaa54fd1eba1fe97a367ff.png" width="1024" height="576" class="img_ev3q"></p>
<p>Figure 2: Decision tree when users select <strong>Join</strong> in chooseDomainJoinActivity.</p>
<p><img decoding="async" loading="lazy" src="/technical-notes-for-microsoft-workloads-on-aws/assets/images/image3-7a6e68821221f3b85bffec0ea62d6c35.png" width="1024" height="576" class="img_ev3q"></p>
<p>Figure 3: Decision tree when users select <strong>Unjoin</strong> in chooseDomainJoinActivity.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="join-and-unjoin-domain">Join and unjoin domain<a href="#join-and-unjoin-domain" class="hash-link" aria-label="Direct link to Join and unjoin domain" title="Direct link to Join and unjoin domain" translate="no">​</a></h3>
<p>There are two steps, <em><strong>joinDomain</strong></em> and <em><strong>unjoinDomain</strong></em>, that are associated with the aws<!-- -->:runCommand<!-- --> action. Either of these steps can be run directly on respective Amazon EC2 instances. Since I am working on Windows Server explicitly, I want to run domain join and unjoin related commands using PowerShell with the aid of the <strong><a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/powershell-run-command-linux.html" target="_blank" rel="noopener noreferrer" class="">AWS-RunPowerShellScript</a></strong> command document. Visit aws<!-- -->:runCommand<!-- --> to learn more.</p>
<p>The PowerShell statements in both the <em><strong>joinDomain</strong></em> and <em><strong>unjoinDomain</strong></em> steps are wrapped in the try and catch blocks. If either step succeeds, the Amazon EC2 instance will be tagged to indicate the instance has been joined or unjoined to or from the AD domain. Reboots are only applied upon a successful domain join executing the <em><strong>rebootServer</strong></em> step upon the join activity. Otherwise, the runbook will stop the EC2 instance by running the <em><strong>stopServer</strong></em> step upon the unjoin activity. If either step fails, a <strong>Failed</strong> status is returned and outputted in the Systems Manager Automation console. The Automation also runs the <em><strong>failADEC2Tag</strong></em> step**,** which tags the Amazon EC2 instance to reflect the failure and then runs the <em><strong>stopServer</strong></em> step to stop the Amazon EC2 instance. This allows you to troubleshoot the failure and try again.</p>
<p>The following PowerShell statement implements the <em><strong>joinDomain</strong></em> step:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">If ((Get-CimInstance -ClassName &#x27;Win32_ComputerSystem&#x27; -ErrorAction SilentlyContinue | Select-Object -ExpandProperty &#x27;PartOfDomain&#x27;) -eq $false) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $jsonSecretValue = (Get-SECSecretValue -SecretId ${SecretKeyADPasswordResource}).SecretString | ConvertFrom-Json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $targetOU = $jsonSecretValue.defaultTargetOU</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $domainName = $jsonSecretValue.domainName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $domainJoinUserName = $jsonSecretValue.domainJoinUserName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $domainJoinPassword = $jsonSecretValue.domainJoinPassword | ConvertTo-SecureString -AsPlainText -Force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } Catch [System.Exception] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Output &quot;Failed to get secret $_&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $domainCredential = New-Object System.Management.Automation.PSCredential($domainJoinUserName, $domainJoinPassword)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Output &quot;Attempting to join $env:COMPUTERNAME to Active Directory domain: $domainName and moving $env:COMPUTERNAME to the following OU: $targetOU.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Add-Computer -ComputerName $env:COMPUTERNAME -DomainName $domainName -Credential $domainCredential -OUPath $targetOU -Restart:$false -ErrorAction Stop </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } Catch [System.Exception] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Output &quot;Failed to add computer to the domain $_&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} Else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Write-Output &quot;$env:COMPUTERNAME is already part of the Active Directory domain $domainName.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Exit 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The following PowerShell statement implements the <em><strong>unjoinDomain</strong></em> step:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">If ((Get-CimInstance -ClassName &#x27;Win32_ComputerSystem&#x27; -ErrorAction SilentlyContinue | Select-Object -ExpandProperty &#x27;PartOfDomain&#x27;) -eq $true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $jsonSecretValue = (Get-SECSecretValue -SecretId ${SecretKeyADPasswordResource}).SecretString | ConvertFrom-Json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $domainName = $jsonSecretValue.domainName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $domainJoinUserName = $jsonSecretValue.domainJoinUserName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $domainJoinPassword = $jsonSecretValue.domainJoinPassword | ConvertTo-SecureString -AsPlainText -Force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } Catch [System.Exception] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Output &quot;Failed to get secret $_&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $domainCredential = New-Object System.Management.Automation.PSCredential($domainJoinUserName, $domainJoinPassword)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    If (-not (Get-WindowsFeature -Name &#x27;RSAT-AD-Tools&#x27; -ErrorAction SilentlyContinue | Select-Object -ExpandProperty &#x27;Installed&#x27;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Output &#x27;Installing RSAT AD Tools to allow domain joining&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $Null = Add-WindowsFeature -Name &#x27;RSAT-AD-Tools&#x27; -ErrorAction Stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } Catch [System.Exception] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Write-Output &quot;Failed to install RSAT AD Tools $_&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $getADComputer = (Get-ADComputer -Identity $env:COMPUTERNAME -Credential $domainCredential)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $distinguishedName = $getADComputer.DistinguishedName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Remove-Computer -ComputerName $env:COMPUTERNAME -UnjoinDomainCredential $domainCredential -Verbose -Force -Restart:$false -ErrorAction Stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Remove-ADComputer -Credential $domainCredential -Identity $distinguishedName -Server $domainName -Confirm:$False -Verbose -ErrorAction Stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } Catch [System.Exception] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Output &quot;Failed to remove $env:COMPUTERNAME from the $domainName domain and in a Windows Workgroup. $_&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} Else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Write-Output &quot;$env:COMPUTERNAME is not part of the Active Directory domain $domainName and already part of a Windows Workgroup.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Exit 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Note:</strong> When automating a large number of AD domain unjoins, for example with an <a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/auto-scaling-groups.html" target="_blank" rel="noopener noreferrer" class="">Auto Scaling group</a>, you potentially leave a large number of computer objects in the Active Directory deleted object container for up to 360 days. A separate automation can remove these objects using the following PowerShell cmdlet:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Get-ADObject -filter {sAMAccountName -eq &quot;$&quot;} -includeDeletedObjects -property * | Remove-ADObject.</span><br></span></code></pre></div></div>
<p>To learn more, visit <a href="https://learn.microsoft.com/en-us/powershell/module/activedirectory/get-adobject?view=windowsserver2022-ps" target="_blank" rel="noopener noreferrer" class="">Get-ADObject</a>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="secret-store-ad-domain-configuration">Secret store AD domain configuration<a href="#secret-store-ad-domain-configuration" class="hash-link" aria-label="Direct link to Secret store AD domain configuration" title="Direct link to Secret store AD domain configuration" translate="no">​</a></h3>
<p>The runbook uses a secret to store the AD credentials in Secrets Manager. Secrets Manager helps you manage and retrieve the AD credentials needed to perform AD join and unjoin activities. The secret is encrypted and decrypted with an AWS KMS <a href="https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#customer-cmk" target="_blank" rel="noopener noreferrer" class="">customer managed key</a>. The customer managed key is an AWS KMS key that is created, owned and managed by you and can be shared to other AWS accounts and AWS Regions if needed. The secret and customer managed key are referenced in the runbook, specifically in the PowerShell scripts, by using the secret&#x27;s value and customer managed key ID specified when the secret is created. These values are not hard coded in the PowerShell code, allowing AD admins to rotate the password and securely update the secret without modifying the code.</p>
<p>In particular, this solution uses 4 values:</p>
<ul>
<li class="">Fully qualified domain name (FQDN) of the AD domain.</li>
<li class="">AD username.</li>
<li class="">AD password.</li>
<li class="">Specific [organizational unit (OU)] in AD where the computer account for the domain-joined instance will be created.</li>
</ul>
<p>Below is an example of the secret stored in JSON within Secrets Manager with the AD credentials, domain name, and OU, all of which are required to complete the domain join and unjoin activities. The CloudFormation template will create the secret automatically after filling in the input parameters <strong>(Figure 1)</strong>.</p>
<p><strong>Note:</strong> The keys and values are case sensitive. The plaintext value of the <strong>domainJoinUserName</strong> key requires two backslashes to parse the down-level logon name format.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;domainName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;corp.example.com&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;domainJoinUserName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CORP\\Admin&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;domainJoinPassword&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;YOURPASSWORD&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;defaultTargetOU&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;OU=Computers,OU=CORP,dc=corp,dc=example,dc=com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="configure-amazon-ec2-permissions">Configure Amazon EC2 permissions<a href="#configure-amazon-ec2-permissions" class="hash-link" aria-label="Direct link to Configure Amazon EC2 permissions" title="Direct link to Configure Amazon EC2 permissions" translate="no">​</a></h3>
<p>The CloudFormation stack creates an instance profile that passes permissions to an Amazon EC2 instance. You will need to attach this instance profile to Amazon EC2 instances to perform AD join or unjoin. This role gives your Amazon EC2 instances permissions to Systems Manager core functionality by the <strong>AmazonSSMManagedInstanceCore</strong> AWS managed policy, get the secret value stored in Secrets Manager, and decrypt the customer managed key in AWS KMS.</p>
<p>The CloudFormation stack also creates a customer managed policy to access Secrets Manager and AWS KMS.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;Version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2012-10-17&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;Statement&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Action&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;secretsmanager:GetSecretValue&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;kms:DescribeKey&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;kms:Decrypt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Resource&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;arn:aws:secretsmanager:AWSREGION:YOURACCOUNTID:secret:YOURADSECRET&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;arn:aws:kms:AWSREGION:YOURACCOUNTID:key/YOURKMSKEYID&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Effect&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Allow&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="putting-it-all-together">Putting it all together<a href="#putting-it-all-together" class="hash-link" aria-label="Direct link to Putting it all together" title="Direct link to Putting it all together" translate="no">​</a></h3>
<p>Now that the key steps in the runbook and the secret needed are recognized, I will walk through an example of how to manually domain join an Amazon EC2 instance.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites" translate="no">​</a></h4>
<ul>
<li class="">An <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html" target="_blank" rel="noopener noreferrer" class="">AWS CloudFormation</a> template to deploy the Automation runbook. To create the Automation runbook manually, download the <a href="https://github.com/aws-samples/ssm-automation-custom-ad-domain-join-unjoin/blob/main/templates/systemsmanager/ssm-automation-domainjoinunjoin.yaml" target="_blank" rel="noopener noreferrer" class="">ssm-automation-domainjoinunjoin.yaml</a> template and author a custom Automation runbook.</li>
<li class="">AD join/unjoin relevant credentials stored in <a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/intro.html" target="_blank" rel="noopener noreferrer" class="">AWS Secrets Manager</a>.</li>
<li class=""><a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/automation-actions.html" target="_blank" rel="noopener noreferrer" class="">Automation actions</a> to run PowerShell.</li>
<li class="">An <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html" target="_blank" rel="noopener noreferrer" class="">instance profile</a> that passes an AWS Identity and Access Management (IAM) role to an EC2 instance with minimum permissions for Secrets Manager and <a href="https://docs.aws.amazon.com/kms/latest/developerguide/overview.html" target="_blank" rel="noopener noreferrer" class="">AWS Key Management Service</a> (AWS KMS)</li>
</ul>
<p><strong>Note:</strong> This guide assumes your DNS has been configured already for your AD environment running in AWS. Configuring DNS at scale is beyond the scope of this blog. You can review existing guides to configure such an environment with either <a href="https://d1.awsstatic.com/whitepapers/aws-hybrid-dns-with-active-directory.pdf" target="_blank" rel="noopener noreferrer" class="">Amazon Route 53 Resolver endpoints</a> or <a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_DHCP_Options.html" target="_blank" rel="noopener noreferrer" class="">DHCP option sets in Amazon VPC</a>.</p>
<ol>
<li class="">Open the <a href="https://console.aws.amazon.com/systems-manager" target="_blank" rel="noopener noreferrer" class="">AWS Systems Manager console</a>.</li>
<li class="">In the navigation pane, choose <strong>Automation</strong> and then choose <strong>Execute automation</strong> (Figure 4).</li>
</ol>
<p><img decoding="async" loading="lazy" src="/technical-notes-for-microsoft-workloads-on-aws/assets/images/image4-5280a83ce813c05262de069509bad8a8.png" width="1431" height="953" class="img_ev3q"></p>
<p>Figure 4: Execution automation in AWS Systems Manager.</p>
<ol start="3">
<li class="">In the <strong>Automation document</strong> list, select the <strong>Owned by me</strong> tab to view the custom runbook. Select the <strong>SSM-Automation-AD-Join</strong> runbook.</li>
<li class="">In the <strong>Document details</strong> section, verify that <strong>Document version</strong> is set to <strong>Default version at runtime</strong>. While I will choose the default version in this example, the system includes the following version options:<!-- -->
<ul>
<li class=""><strong>Default version at runtime</strong>: Choose this option if the Automation runbook is updated periodically and a new default version is assigned.</li>
<li class=""><strong>Latest version at runtime</strong>: Choose this option if the Automation runbook is updated periodically, and you want to run the version that was most recently updated.</li>
<li class=""><strong>1 (Default)</strong>: Choose this option to run the first version of the document, which is the default (Figure 5).</li>
</ul>
</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Figure 5: Choose automation runbook." src="/technical-notes-for-microsoft-workloads-on-aws/assets/images/image5-94bb20b63b4aac62c5de28258727b59a.png" width="1024" height="435" class="img_ev3q"></p>
<p>Figure 5: Choose automation runbook.</p>
<ol start="5">
<li class="">Choose <strong>Next</strong>.</li>
<li class="">In the <strong>Execution Mode</strong> section, choose <strong>Simple execution</strong>.</li>
<li class="">In the <strong>Input parameters</strong> section, specify the required inputs.<!-- -->
<ul>
<li class="">Select an <strong>Instance ID</strong> from the interactive instance picker.</li>
<li class="">In the <strong>DomainJoinActivity</strong> dropdown, select <strong>Join</strong>.</li>
</ul>
</li>
<li class="">Choose <strong>Execute</strong> (Figure 6).</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Figure 6: Select your instance and DomainJoinActivity. This example demonstrates the Join activity." src="/technical-notes-for-microsoft-workloads-on-aws/assets/images/image6-9d6f2a4858328e4f3058a79c0d1b2070.png" width="1024" height="462" class="img_ev3q"></p>
<p>Figure 6: Select your instance and DomainJoinActivity. This example demonstrates the Join activity.</p>
<p><strong>Note:</strong> Simple execution targets a single Amazon EC2 instance. To deploy this runbook against multiple Amazon EC2 instances, you can choose <strong>Rate control</strong> in the <strong>Execution Mode</strong> section. In this mode, you can define your targets based on different parameters. For example, you can select <em><strong>InstanceId</strong></em> as the <strong>Parameter</strong> and <em><strong>Parameter Values</strong></em> as the <strong>Targets</strong>. From there, you can multi-select all of the Amazon EC2 instances you want to join to AD. Refer to Figure 7 to see what this looks like and our <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/automation-working-targets-and-rate-controls.html" target="_blank" rel="noopener noreferrer" class="">Run automations at scale</a> for more details on how to deploy runbooks for multiple targets.</p>
<p><img decoding="async" loading="lazy" alt="Figure 7: Selecting multiple instances and to configure DomainJoinActivity to perform the Join activity." src="/technical-notes-for-microsoft-workloads-on-aws/assets/images/image7-49a0b608bcf32eefc9751252ac57b2f8.png" width="1024" height="816" class="img_ev3q"></p>
<p>Figure 7: Selecting multiple instances and to configure DomainJoinActivity to perform the Join activity.</p>
<ol start="9">
<li class="">The <strong>Execution detail</strong> screen will show a green banner stating <strong>Execution has been initiated</strong>. From here, each individual step is run in the <strong>Executed steps</strong>.<!-- -->
<ul>
<li class="">The overall status is available in the <strong>Executions status</strong>.</li>
<li class="">Each step can be viewed by clicking on the <strong>Step ID</strong> link along with start and end time stamps.</li>
<li class="">The <strong>Step ID</strong> is unique to every execution.</li>
</ul>
</li>
<li class="">Each step indicates individual <strong>Success</strong> or <strong>Failed</strong> in the <strong>Status</strong> column (Figure 8).</li>
</ol>
<p><img decoding="async" loading="lazy" src="/technical-notes-for-microsoft-workloads-on-aws/assets/images/image8-014dd5a47a5a6ef105bc39d9e7f4ecf1.png" width="1823" height="994" class="img_ev3q"></p>
<p>Figure 8: Execution detail screen showing <strong>Success</strong> and the executed steps.</p>
<ol start="11">
<li class="">For example, to see the details of Step #3, I can select the Step ID.</li>
<li class="">Since this step runs PowerShell locally on the Windows Amazon EC2 instance, the <strong>Outputs</strong> displays PowerShell output relevant to the <strong><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/add-computer?view=powershell-5.1" target="_blank" rel="noopener noreferrer" class="">Add-Computer</a></strong> cmdlet.</li>
<li class="">To go back to the <strong>Execution detail</strong> screen, select <strong>Back to execution detail</strong> (Figure 9).</li>
</ol>
<p><img decoding="async" loading="lazy" src="/technical-notes-for-microsoft-workloads-on-aws/assets/images/image9-49ec67107793958fe41d90f88382dc1d.png" width="1819" height="820" class="img_ev3q"></p>
<p>Figure 9: An example of a successful step details and outputs.</p>
<ol start="14">
<li class="">After all the execution steps have successfully completed, the Windows Amazon EC2 instance has been joined to AD.</li>
</ol>
<p>The process to join a Windows Amazon EC2 instance to AD is easy using Automation. With Automation, you can review the steps as they are processed or follow-up from within the Systems Manager console at any time. If a failure occurs on any step, the entire process will stop, and the failed process can be reviewed by selecting the <strong>Step ID</strong>.</p>
<p>Below are example screenshots of a failed domain join attempt due to an improper parameter configuration. Step 3 failed and is clearly indicated with a status of <strong>Failed</strong> (Figure 10). The specific output of the failure is a specific PowerShell error related to the <strong>Add-Computer</strong> cmdlet (Figure 11).</p>
<p><img decoding="async" loading="lazy" src="/technical-notes-for-microsoft-workloads-on-aws/assets/images/image10-2c0aeb22d411c6dbc20f88904bec46d1.png" width="1817" height="989" class="img_ev3q"></p>
<p>Figure 10: Execution detail screen with a failure in Step 3.</p>
<p><img decoding="async" loading="lazy" src="/technical-notes-for-microsoft-workloads-on-aws/assets/images/image11-678109a584f8a8b87c92ec7e88e5ccdc.png" width="1813" height="1050" class="img_ev3q"></p>
<p>Figure 11: An example of a failed step details and outputs.</p>
<p>Finally, to remove the Amazon EC2 instance from AD, simply rerun the Automation runbook and select <strong>Unjoin</strong> in the <strong>DomainJoinActivity</strong> dropdown (Figure 12). Similar to the domain join process, the unjoin process will run the <strong><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/remove-computer?view=powershell-5.1" target="_blank" rel="noopener noreferrer" class="">Remove-Computer</a></strong> and <strong><a href="https://docs.microsoft.com/en-us/powershell/module/activedirectory/remove-adcomputer?view=windowsserver2019-ps" target="_blank" rel="noopener noreferrer" class="">Remove-ADComputer</a></strong> cmdlets to remove the instance from AD and clean up AD immediately.</p>
<p><img decoding="async" loading="lazy" alt="Figure 12: An example runbook execution where the DomainJoinActivity is configured for the Unjoin activity." src="/technical-notes-for-microsoft-workloads-on-aws/assets/images/image12-aaf23f2e402b6de49205f94471cd5d29.png" width="1024" height="467" class="img_ev3q"></p>
<p>Figure 12: An example runbook execution where the DomainJoinActivity is configured for the <strong>Unjoin</strong> activity.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/aws-samples/technical-notes-for-microsoft-workloads-on-aws/blob/main/docusaurus/docs/Active Directory/Guides/Active_Directory_domain_join_with_AWS_Systems_Manager_and_AWS_Secrets_Manager/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/technical-notes-for-microsoft-workloads-on-aws/Active Directory/Guides/Optimizing_Directory_Sharing_in_AWS_Managed_Microsoft_AD/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Optimizing Directory Sharing in AWS Managed Microsoft AD</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/technical-notes-for-microsoft-workloads-on-aws/Windows Containers/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Windows Containers</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#solution-overview" class="table-of-contents__link toc-highlight">Solution overview</a></li><li><a href="#the-automation-runbook-workflow" class="table-of-contents__link toc-highlight">The Automation runbook workflow</a><ul><li><a href="#parameters" class="table-of-contents__link toc-highlight">Parameters</a></li></ul></li><li><a href="#runbook-steps" class="table-of-contents__link toc-highlight">Runbook steps</a><ul><li><a href="#join-and-unjoin-domain" class="table-of-contents__link toc-highlight">Join and unjoin domain</a></li><li><a href="#secret-store-ad-domain-configuration" class="table-of-contents__link toc-highlight">Secret store AD domain configuration</a></li><li><a href="#configure-amazon-ec2-permissions" class="table-of-contents__link toc-highlight">Configure Amazon EC2 permissions</a></li><li><a href="#putting-it-all-together" class="table-of-contents__link toc-highlight">Putting it all together</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Built with ❤️ at AWS. <br> © 2026.  Amazon.com, Inc. or its affiliates. All Rights Reserved.</div></div></div></footer></div>
</body>
</html>